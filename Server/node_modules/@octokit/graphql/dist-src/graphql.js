import { request as Request } from "@octokit/request";
import { GraphqlResponseError } from "./error";

// An array of option keys that do not accept variable values
const NON_VARIABLE_OPTIONS = [
  "method",
  "baseUrl",
  "url",
  "headers",
  "request",
  "query",
  "mediaType"
];

// An array of option keys that are forbidden to be used as variable names
const FORBIDDEN_VARIABLE_OPTIONS = ["query", "method", "url"];

// A regular expression to match the GHES v3 API suffix
const GHES_V3_SUFFIX_REGEX = /\/api\/v3\/?$/;

// The main graphql function
function graphql(request, query, options) {
  if (options) {
    // Check if "query" is used as a variable name when it's already defined as a string
    if (typeof query === "string" && "query" in options) {
      return Promise.reject(
        new Error(`[@octokit/graphql] "query" cannot be used as variable name`)
      );
    }

    // Check if any forbidden variable options are used as variable names
    for (const key in options) {
      if (!FORBIDDEN_VARIABLE_OPTIONS.includes(key)) continue;
      return Promise.reject(
        new Error(
          `[@octokit/graphql] "${key}" cannot be used as variable name`
        )
      );
    }
  }

  // Prepare the parsed options by merging query and options if query is a string
  const parsedOptions = typeof query === "string" ? Object.assign({ query }, options) : query;

  // Filter and format the options based on variable and non-variable options
  const requestOptions = Object.keys(
    parsedOptions
  ).reduce((result, key) => {
    if (NON_VARIABLE_OPTIONS.includes(key)) {
      result[key] = parsedOptions[key];
      return result;
    }
    if (!result.variables) {
      result.variables = {};
    }
    result.variables[key] = parsedOptions[key];
    return result;
  }, {});

  // Get the base URL from options or use the default base URL from the request endpoint
  const baseUrl = parsedOptions.baseUrl || request.endpoint.DEFAULTS.baseUrl;

  // If the base URL matches the GHES v3 API suffix, update the URL for GraphQL API
  if (GHES_V3_SUFFIX_REGEX.test(baseUrl)) {
    requestOptions.url = baseUrl.replace(GHES_V3_SUFFIX_REGEX, "/api/graphql");
  }

  // Send the request and handle the response
  return request(requestOptions).then((response) => {
    if (response.data.errors) {
      const headers = {};
      for (const key of Object.keys(response.headers)) {
        headers[key] = response.
